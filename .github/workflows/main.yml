name: Supabase Backup to Google Drive

on:
  workflow_dispatch:
  schedule:
    # 매일 03:00 KST = 전날 18:00 UTC
    - cron: "0 18 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest

    env:
      PGHOST: ${{ secrets.SUPABASE_DB_HOST }}
      PGPORT: ${{ secrets.SUPABASE_DB_PORT }}
      PGDATABASE: ${{ secrets.SUPABASE_DB_NAME }}
      PGUSER: ${{ secrets.SUPABASE_DB_USER }}
      PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      PGSSLMODE: require
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools (pg_dump 17, rclone)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release rclone
          wget -qO - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Dump database (pg_dump) and compress
        run: |
          pg_dump -F c --no-owner --no-acl -f supabase.dump
          gzip supabase.dump

      - name: Configure rclone for Google Drive (Service Account)
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}' > ~/.config/rclone/sa.json
          cat <<EOF > ~/.config/rclone/rclone.conf
          [gdrive]
          type = drive
          scope = drive
          service_account_file = ~/.config/rclone/sa.json
          EOF

      - name: Upload to Google Drive folder
        run: |
          rclone copy supabase.dump.gz gdrive:${GDRIVE_FOLDER_ID}
