name: Supabase Backup to Google Drive

on:
  workflow_dispatch:
  schedule:
    # 매일 03:00 KST = 전날 18:00 UTC
    - cron: "0 18 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      PGHOST: ${{ secrets.SUPABASE_DB_HOST }}
      PGPORT: ${{ secrets.SUPABASE_DB_PORT }}
      PGDATABASE: ${{ secrets.SUPABASE_DB_NAME }}
      PGUSER: ${{ secrets.SUPABASE_DB_USER }}
      PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      PGSSLMODE: require

      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
- name: Install tools (pg_dump 17, rclone)
  run: |
    sudo apt-get update
    sudo apt-get install -y wget gnupg lsb-release rclone

    # PostgreSQL 공식 저장소 추가
    wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
    echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list

    sudo apt-get update
    sudo apt-get install -y postgresql-client-17

      - name: Prepare filenames
        id: vars
        run: |
          TS="$(date -u +'%Y-%m-%dT%H%M%SZ')"
          echo "ts=$TS" >> $GITHUB_OUTPUT
          echo "gz=supabase_${TS}.dump.gz" >> $GITHUB_OUTPUT

      - name: Dump database (pg_dump) and compress
        run: |
          pg_dump -F c --no-owner --no-acl -f supabase.dump
          gzip -9 supabase.dump
          mv supabase.dump.gz "${{ steps.vars.outputs.gz }}"

      - name: Configure rclone for Google Drive (Service Account)
        env:
          GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [gdrive]
          type = drive
          scope = drive
          service_account_credentials = ${GDRIVE_SA_JSON}
          EOF

      - name: Upload to Google Drive folder
        run: |
          rclone copy "${{ steps.vars.outputs.gz }}" "gdrive:" \
            --drive-root-folder-id "${GDRIVE_FOLDER_ID}" -v
